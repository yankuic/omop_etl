# OMOP ETL

## Part I. Install Git and Download (or 'pull' in Git's term) Python Library.

### 1. Check to see if you have Anaconda, a virtual enviroment and package managing library for python. If not, you will need to install Anaconda first.



### 2. Check to see if you have Git. If not, you will need to install Git first. 


### 3. If this is your first time pulling the central repository (repo) from IDR shared drive, clone the central git repo to your local directory. Otherwise, skip to the next step.

    $ git clone [placeholder]

### 4. Since we already have a local copy of omop_etl,  we will commit the changes in our local repo first.

    $ git ...


### Next, to sync our local repo with the central repo, we need to pull omop_etl from the central repo. Type in command as follows:

    $ git pull origin master


## Part II. Install/re-install OMOP_ETL

### 1. To install or re-install omop_etl package, go to the omop_etl folder. Open a Git Bash command line window, and type in command as follows to run setup.py: 

    $ python setup.py install --record files.txt

### 2. Use omop_etl to create new project.

- Create config.yml file with project env info.
- Generates project structure for log files, reports, etc.
- Instructions for users: All commands must be executed within the omop project directory, where the files config.yml and refresh_cohort.py must exist. Here is what your omop_project_dir should look like:

        omop_project_dir
        |__config.yml
        |__refresh_cohort.py


- Update vocabulary

    Not implemented

- Create new project.

This will setup the env.....

        # Template:
        $ omot_etl new_project -p <path to my new project> -n <myproject> -db <project database> -s <server>
        # Example of a OMOP project named 'omop_project1': 
        $ omop_etl new_project -p ./ -n omop_project1 -db dws_cc_omop -s edw.shands.ufl.edu

### 3. Now you have successfully installed omop_etl package.


## Part III. ETL Steps Using OMOP_ETL

### 1. Overview of db schemas that will be generated by omop_etl:

    - Vocabulary tables are in xref schema.
    - Mapping tables are in xref schema.
    - Raw data are in stage schema.
    - Pre-processed data is in preload schema.
    - Postprocessed tables are in dbo schema.

### 2. Configure project.

Navigate to omop project directory.

    $ cd omop_project1


### 3. Refresh cohort. 

This is to create the cohort table in db.

    $ omop_project1> python refresh_cohort.py

### 4. Staging data. 

Mapping tables will be updated during this step.

    $ omop_project1> omop_etl stage --all

### 5. Preload data. 

This will insert data from subsets into one table.

    $ omop_project1> omop_etl preload --all

### 6. Load data.

    $ omop_project1> omop_etl load --all

### 7. Move records to match domain_id with domain table

    $ omop_project1> omop_etl postproc --fix_domains

### 8. Generate hipaa compliant dataset

- For de-identified dataset run

        $ omop_project1> omop_etl postproc --deid


- For limited dataset run

        $ omop_project1> omop_etl postproc --limited


[update is up to here...]

### 9. Export to csv files

    Not implemented

